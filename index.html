<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redmond Digital Flea Market (3D)</title>

  <!-- IMPORTANT: Import maps polyfill helps browsers that struggle with importmaps (e.g., Firefox/Safari cases). -->
  <!-- This kind of issue is widely reported in three.js importmap discussions. -->
  <script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script> <!-- [1](https://github.com/mrdoob/three.js/issues/23702) -->

  <style>
    html, body { margin:0; height:100%; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#87ceeb; }
    #ui { position:fixed; inset:0; pointer-events:none; }

    #errorOverlay{
      position:fixed; inset:0;
      display:none;
      background: rgba(0,0,0,0.75);
      color:#fff;
      padding: 14px;
      z-index: 9999;
      overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      pointer-events:auto;
    }
    #errorOverlay h3{ margin:0 0 8px; font-family: system-ui, sans-serif; }
    #errorOverlay pre{ white-space: pre-wrap; }

    #topbar{
      pointer-events:auto;
      position:fixed; left:12px; right:12px; top:12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      z-index: 50;
    }
    .card{
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(8px);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .title{ font-weight:900; }
    .sub{ font-size:12px; opacity:0.8; margin-top:2px; }

    .btn{
      border:0; border-radius:12px; padding:10px 12px;
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(8px);
      cursor:pointer;
      white-space:nowrap;
    }

    #leftPanel{
      pointer-events:auto;
      position:fixed;
      left:12px;
      top:76px;
      width:min(360px, calc(100vw - 24px));
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(8px);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      z-index: 40;
    }
    #leftPanel h3{ margin:0 0 8px; font-size:14px; }
    #search{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.12);
      outline: none;
      font-size: 14px;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      display:flex; gap:8px; align-items:center;
      background: rgba(0,0,0,0.05);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      user-select:none;
    }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; border: 1px solid rgba(0,0,0,0.15); }
    #legend{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(0,0,0,0.10);
      font-size: 12px;
      opacity:0.85;
      line-height: 1.1rem;
    }

    #crosshair{
      position:fixed; left:50%; top:50%;
      transform: translate(-50%,-50%);
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,0.95);
      border-radius: 999px;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.15);
      pointer-events:none;
      opacity:0.9;
      z-index: 30;
    }
    #crosshair::after{
      content:"";
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:4px; height:4px;
      background: rgba(255,255,255,0.95);
      border-radius:999px;
    }

    #hint{
      position:fixed; left:12px; bottom:12px;
      max-width:min(900px, calc(100vw - 24px));
      pointer-events:none;
      color:#fff;
      background: rgba(0,0,0,0.55);
      border-radius: 14px;
      padding: 10px 12px;
      line-height: 1.25rem;
      font-size: 14px;
      z-index: 30;
    }
    #hint b{ color:#ffe58a; }

    #actionPrompt{
      position:fixed;
      left:50%; bottom:92px;
      transform:translateX(-50%);
      background: rgba(0,0,0,0.62);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 14px;
      display:none;
      pointer-events:none;
      z-index: 30;
    }

    #minimapFrame{
      position:fixed;
      top:70px; right:14px;
      width:220px; height:220px;
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,0.85);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      pointer-events:none;
      z-index: 20;
    }
    #minimapLabel{
      position:fixed;
      top:44px; right:14px;
      color:#fff;
      background: rgba(0,0,0,0.55);
      padding:6px 10px;
      border-radius: 999px;
      font-size: 12px;
      pointer-events:none;
      z-index: 20;
    }

    #takeControl{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.40);
      z-index: 60;
      pointer-events:auto;
    }
    #takeControl .panel{
      width:min(560px, calc(100vw - 24px));
      background: rgba(255,255,255,0.92);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    #takeControl h2{ margin:0 0 8px; }
    #takeControl p{ margin:8px 0; opacity:0.85; }
    #takeControl .primary{
      background:#111; color:#fff;
      padding: 10px 12px; border-radius: 12px; border:0;
      cursor:pointer;
      font-weight: 800;
    }

    /* Booth info modal */
    #modalOverlay{
      position:fixed; inset:0; background: rgba(0,0,0,0.60);
      display:none; align-items:center; justify-content:center;
      z-index: 70;
      pointer-events:auto;
      padding: 14px;
    }
    #modal{
      width:min(980px, calc(100vw - 24px));
      max-height:min(86vh, 900px);
      overflow:auto;
      background: rgba(255,255,255,0.94);
      border-radius: 18px;
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    #modalHeader{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    #modalHeader h2{ margin:0; }
    #modalHeader p{ margin:8px 0 0; opacity:0.8; }
    .pills{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .pill{
      display:inline-block; padding:8px 10px; border-radius:999px;
      background: rgba(0,0,0,0.06);
      text-decoration:none; color:#111; font-size:14px;
    }
    .prodGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap:10px;
      margin-top: 14px;
    }
    .prodCard{
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,0.9);
      display:flex; flex-direction:column; gap:8px;
    }
    .prodCard .name{ font-weight:800; }
    .prodCard .price{ opacity:0.75; font-size:13px; }
    .prodCard a{
      display:inline-block;
      text-decoration:none;
      background:#111; color:#fff;
      padding:10px 12px;
      border-radius: 12px;
      text-align:center;
      font-weight:800;
    }

    /* Product modal */
    #productOverlay{
      position:fixed; inset:0; background: rgba(0,0,0,0.65);
      display:none; align-items:center; justify-content:center;
      z-index: 75;
      pointer-events:auto;
      padding: 14px;
    }
    #productModal{
      width:min(720px, calc(100vw - 24px));
      background: rgba(255,255,255,0.96);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    #productModal h3{ margin:0; }
    #productModal .meta{ margin-top:6px; opacity:0.75; }
    #productModal .actions{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; }
    .primaryBtn{
      border:0; border-radius:12px; padding:10px 12px;
      background:#111; color:#fff; cursor:pointer;
      text-decoration:none; display:inline-block;
      font-weight:800;
    }
  </style>

  <!-- Switch to jsDelivr which is often more reliable than unpkg for some users. -->
  <!-- External CDNs can fail; switching is a common mitigation. [2](https://discourse.threejs.org/t/unpkg-cdn-link-sometimes-seem-to-fail/64109) -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
      }
    }
  </script>
</head>

<body>
  <div id="errorOverlay">
    <h3>Something went wrong</h3>
    <pre id="errorText"></pre>
  </div>

  <canvas id="c"></canvas>

  <div id="ui">
    <div id="topbar">
      <div class="card">
        <div class="title">Redmond Digital Flea Market</div>
        <div class="sub">Walk the aisle • Enter booths • Shop products • Discover local makers</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" id="vendorBtn">Vendor Submit</button>
        <button class="btn" id="soundBtn">Sound: Off</button>
        <button class="btn" id="helpBtn">Help</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>
    </div>

    <div id="leftPanel">
      <h3>Find vendors</h3>
      <input id="search" placeholder="Search (e.g., jewelry, pottery, crochet)..." />
      <div class="chips" id="categoryChips"></div>
      <div id="legend"></div>
    </div>

    <div id="minimapLabel">Mini‑map</div>
    <div id="minimapFrame"></div>

    <div id="crosshair"></div>
    <div id="actionPrompt"></div>

    <div id="hint">
      <b>WASD</b> move • <b>Mouse</b> look (after you take control) • <b>E</b> enter booth • <b>Q</b> exit booth • Click sign/products to open links
    </div>

    <div id="takeControl">
      <div class="panel">
        <h2>Welcome to the Market</h2>
        <p>You’re at the entrance. The camera will start walking forward. Click once to take control (mouse‑look + WASD) and enable sound.</p>
        <button class="primary" id="takeControlBtn">Take Control</button>
      </div>
    </div>

    <div id="modalOverlay">
      <div id="modal">
        <div id="modalHeader">
          <div>
            <h2 id="mTitle">Business Name</h2>
            <p id="mDesc">Description</p>
            <div class="pills" id="mLinks"></div>
          </div>
          <button class="btn" id="closeModal">Close</button>
        </div>
        <div id="mProducts"></div>
      </div>
    </div>

    <div id="productOverlay">
      <div id="productModal">
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
          <div>
            <h3 id="pTitle">Product</h3>
            <div class="meta" id="pMeta"></div>
            <div class="meta" id="pPrice"></div>
          </div>
          <button class="btn" id="closeProduct">Close</button>
        </div>
        <div class="actions">
          <a class="primaryBtn" id="pBuy" target="_blank" rel="noopener noreferrer">Buy / Visit</a>
          <button class="btn" id="pOpenBooth">Open Booth Info</button>
        </div>
        <div style="margin-top:10px; font-size:12px; opacity:0.7;">
          Replace example product links with real Etsy/Square/Shopify/Stripe links when ready.
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // ---- On-screen error reporting (so you never get “blank blue” silently again) ----
  const errorOverlay = document.getElementById("errorOverlay");
  const errorText = document.getElementById("errorText");
  function showError(msg) {
    errorText.textContent = msg;
    errorOverlay.style.display = "block";
  }
  window.addEventListener("error", (e) => showError(String(e.error?.stack || e.message || e)));
  window.addEventListener("unhandledrejection", (e) => showError(String(e.reason?.stack || e.reason || e)));

  import * as THREE from "three";
  import { PointerLockControls } from "three/addons/controls/PointerLockControls.js";

  // ---- FIX 1: declare isPlaying up front (missing before caused immediate ReferenceError) ----
  let isPlaying = false;

  // -------------------------
  // Categories / Booths (trimmed but functional)
  // -------------------------
  const CATEGORIES = [
    { key:"Jewelry",  color:"#e6ddff" },
    { key:"Ceramics", color:"#d8e8ff" },
    { key:"Crochet",  color:"#e9f7d9" },
    { key:"Art",      color:"#ffd56a" },
    { key:"Gifts",    color:"#fff2cc" },
    { key:"Food",     color:"#ffd1dc" }
  ];
  const catColor = Object.fromEntries(CATEGORIES.map(c => [c.key, c.color]));

  const BOOTHS = [
    {
      id:"vala",
