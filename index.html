<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Redmond Digital Flea Market (3D Free Roam)</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#87ceeb; }
    #ui { position:fixed; inset:0; pointer-events:none; }

    #topbar {
      pointer-events:auto;
      position:fixed; left:12px; right:12px; top:12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      z-index: 20;
    }
    .card {
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(8px);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .title { font-weight: 900; }
    .sub { font-size:12px; opacity:0.8; margin-top:2px; }
    .btn {
      border:0; border-radius:12px; padding:10px 12px;
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(8px);
      cursor:pointer;
    }

    /* Crosshair */
    #crosshair {
      position:fixed; left:50%; top:50%;
      transform: translate(-50%,-50%);
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,0.95);
      border-radius: 999px;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.15);
      pointer-events:none;
      opacity:0.9;
      z-index: 15;
    }
    #crosshair::after{
      content:"";
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:4px; height:4px;
      background: rgba(255,255,255,0.95);
      border-radius:999px;
    }

    /* Hint */
    #hint {
      position:fixed; left:12px; bottom:12px;
      max-width:min(760px, calc(100vw - 24px));
      pointer-events:none;
      color:#fff;
      background: rgba(0,0,0,0.55);
      border-radius: 14px;
      padding: 10px 12px;
      line-height: 1.25rem;
      font-size: 14px;
      z-index: 15;
    }
    #hint b { color: #ffe58a; }

    /* Action prompt (near doors) */
    #actionPrompt {
      position:fixed;
      left:50%; bottom:92px;
      transform:translateX(-50%);
      background: rgba(0,0,0,0.62);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 14px;
      display:none;
      pointer-events:none;
      z-index: 15;
    }

    /* Minimap frame overlay (the actual minimap is rendered into WebGL viewport) */
    #minimapFrame {
      position:fixed;
      top:70px; right:14px;
      width:220px; height:220px;
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,0.85);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      pointer-events:none;
      z-index: 12;
    }
    #minimapLabel{
      position:fixed;
      top:44px; right:14px;
      color:#fff;
      background: rgba(0,0,0,0.55);
      padding:6px 10px;
      border-radius: 999px;
      font-size: 12px;
      pointer-events:none;
      z-index: 12;
    }

    /* Start overlay */
    #startOverlay {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.55);
      z-index: 50;
      pointer-events:auto;
    }
    #startPanel{
      width:min(580px, calc(100vw - 24px));
      background: rgba(255,255,255,0.92);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    #startPanel h2 { margin:0 0 8px; }
    #startPanel p { margin: 8px 0; opacity:0.85; }
    #startPanel .row { display:flex; gap:10px; flex-wrap:wrap; }
    #startPanel .primary {
      background:#111; color:#fff;
      padding: 10px 12px; border-radius: 12px; border:0;
      cursor:pointer;
    }

    /* Modal storefront */
    #modalOverlay{
      position:fixed; inset:0; background: rgba(0,0,0,0.6);
      display:none; align-items:center; justify-content:center;
      z-index: 60;
      pointer-events:auto;
      padding: 14px;
    }
    #modal{
      width:min(980px, calc(100vw - 24px));
      max-height:min(86vh, 900px);
      overflow:auto;
      background: rgba(255,255,255,0.94);
      border-radius: 18px;
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    #modalHeader{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    #modalHeader h2{ margin:0; }
    #modalHeader p{ margin:8px 0 0; opacity:0.8; }
    .pills { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .pill {
      display:inline-block; padding:8px 10px; border-radius:999px;
      background: rgba(0,0,0,0.06);
      text-decoration:none; color:#111; font-size:14px;
    }

    /* Mobile controls */
    #mobileControls{
      position:fixed; inset:0;
      display:none;
      z-index: 40;
      pointer-events:none;
    }
    #joystickWrap{
      position:fixed; left:16px; bottom:18px;
      width:140px; height:140px;
      pointer-events:auto;
      touch-action:none;
      display:flex; align-items:center; justify-content:center;
      opacity:0.95;
    }
    #joyBase{
      width:120px; height:120px; border-radius:999px;
      background: rgba(255,255,255,0.22);
      border: 2px solid rgba(255,255,255,0.45);
      box-shadow: 0 10px 30px rgba(0,0,0,0.20);
      position:relative;
    }
    #joyStick{
      width:54px; height:54px; border-radius:999px;
      background: rgba(255,255,255,0.72);
      border: 2px solid rgba(0,0,0,0.12);
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
    }

    /* Mobile buttons */
    #interactBtn{
      position:fixed; right:16px; bottom:30px;
      pointer-events:auto;
      background: rgba(255,255,255,0.88);
      border:0; border-radius: 16px;
      padding: 14px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.20);
      font-weight: 800;
      touch-action: manipulation;
    }
    #enterBtn{
      position:fixed; right:16px; bottom:92px;
      pointer-events:auto;
      background: rgba(255,255,255,0.88);
      border:0; border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.20);
      font-weight: 900;
      touch-action: manipulation;
      display:none;
    }
    #exitBtn{
      position:fixed; right:16px; bottom:150px;
      pointer-events:auto;
      background: rgba(0,0,0,0.65);
      color:#fff;
      border:0; border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.20);
      font-weight: 900;
      touch-action: manipulation;
      display:none;
    }

    #lookHint{
      position:fixed; right:16px; bottom:206px;
      pointer-events:none;
      color:#fff;
      background: rgba(0,0,0,0.45);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      max-width: 210px;
      line-height: 1.1rem;
    }
  </style>

  <!-- Three.js as ES modules -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
      }
    }
  </script>
</head>

<body>
  <canvas id="c"></canvas>

  <div id="ui">
    <div id="topbar">
      <div class="card">
        <div class="title">Redmond Digital Flea Market</div>
        <div class="sub">FREE ROAM • Mini‑map • Enter booths • Outdoor ambience</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" id="helpBtn">Help</button>
        <button class="btn" id="soundBtn">Sound: Off</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>
    </div>

    <div id="minimapLabel">Mini‑map</div>
    <div id="minimapFrame"></div>

    <div id="crosshair"></div>

    <div id="actionPrompt"></div>

    <div id="hint">
      <b>Desktop:</b> Start → mouse-look + WASD. <b>E</b> enter booth • <b>Q</b> exit booth • Click booth sign to open info.
      <br/>
      <b>Mobile:</b> Joystick move • Swipe right side to look • Tap <b>ENTER</b> near doorway • Tap <b>EXIT</b> inside.
    </div>

    <!-- Mobile -->
    <div id="mobileControls">
      <div id="joystickWrap">
        <div id="joyBase"><div id="joyStick"></div></div>
      </div>
      <button id="interactBtn">INTERACT</button>
      <button id="enterBtn">ENTER</button>
      <button id="exitBtn">EXIT</button>
      <div id="lookHint">Swipe/drag on the right side to look around.</div>
    </div>

    <!-- Start overlay -->
    <div id="startOverlay">
      <div id="startPanel">
        <h2>Enter the Market (3D)</h2>
        <p>
          Desktop uses first‑person mouse look. Mobile uses joystick + swipe-to-look.
        </p>
        <div class="row">
          <button class="primary" id="startBtn">Start (Desktop)</button>
          <button class="btn" id="startMobileBtn">Start (Mobile)</button>
        </div>
        <p style="font-size:12px; opacity:0.8;">
          Tip: Walk close to a tent doorway and press <b>E</b> (or tap <b>ENTER</b>) to go inside.
        </p>
      </div>
    </div>

    <!-- Storefront modal -->
    <div id="modalOverlay">
      <div id="modal">
        <div id="modalHeader">
          <div>
            <h2 id="mTitle">Business Name</h2>
            <p id="mDesc">Description</p>
            <div class="pills" id="mLinks"></div>
          </div>
          <button class="btn" id="closeModal">Close</button>
        </div>
        <div style="margin-top:12px; font-size:12px; opacity:0.75;">
          Links open in a new tab.
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import * as THREE from "three";
  import { PointerLockControls } from "three/addons/controls/PointerLockControls.js";

  // ---------------------------------
  // Booth list (real Redmond examples)
  // ---------------------------------
  const BOOTHS = [
    { id:"vala", name:"VALA Art Center", desc:"Local arts nonprofit in Redmond with exhibits and events.",
      links:[ {label:"Visit Website", url:"https://www.valaeastside.org/"}, {label:"City Info", url:"https://www.redmond.gov/2032/VALA"} ],
      side:"left",  z:-14, color:0xf2d4d7
    },
    { id:"eastsidepottery", name:"Eastside Pottery", desc:"Pottery studio with memberships, workshops, and open studio.",
      links:[ {label:"Visit Website", url:"https://www.eastsidepottery.com/"}, {label:"Listing", url:"https://experienceredmond.com/business/eastside-pottery/"} ],
      side:"right", z:-22, color:0xd8e8ff
    },
    { id:"redmondartworks", name:"Redmond Art Works", desc:"Community art studio near Marymoor Park with classes & open studio.",
      links:[ {label:"Visit Website", url:"https://www.redmondartworks.com/category-s/197.htm"}, {label:"Listing", url:"https://ceramic.school/places/redmond-art-works/"} ],
      side:"left",  z:-30, color:0xe9f7d9
    },
    { id:"paintaway", name:"Paint Away!", desc:"Ceramics painting & glass fusing studio in Redmond Town Center.",
      links:[ {label:"Visit Website", url:"https://paintawaynow.com/"} ],
      side:"right", z:-38, color:0xfff2cc
    },
    { id:"utopia", name:"Utopia (Redmond Town Center)", desc:"Jewelry & gift ideas at Redmond Town Center.",
      links:[ {label:"Directory Listing", url:"https://redmondtowncenter.com/directory/utopia"}, {label:"Handcrafted Gifts Info", url:"https://utopianorthwest.com/pages/handcrafted-jewelry-redmond-wa-98052"} ],
      side:"left",  z:-46, color:0xe6ddff
    },
    { id:"brugge", name:"Brugge Chocolates", desc:"European-style artisan truffles handcrafted in Redmond, WA.",
      links:[ {label:"Shop / Visit", url:"https://www.bruggechocolates.com/"} ],
      side:"right", z:-54, color:0xd9f3ff
    }
  ];

  // -------------------------
  // 1) Renderer / Scene / Cameras
  // -------------------------
  const canvas = document.getElementById("c");
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.autoClear = false;

  const scene = new THREE.Scene();
  scene.fog = new THREE.Fog(0x87ceeb, 18, 180);

  // Sky dome
  scene.add(new THREE.Mesh(
    new THREE.SphereGeometry(260, 32, 16),
    new THREE.MeshBasicMaterial({ color: 0x87ceeb, side: THREE.BackSide })
  ));

  const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 400);
  camera.position.set(0, 1.7, 6);

  // Minimap camera (top-down)
  const minimapCam = new THREE.OrthographicCamera(-18, 18, 18, -18, 0.1, 500);
  minimapCam.up.set(0,0,-1);
  minimapCam.lookAt(new THREE.Vector3(0,0,0));

  // Lights
  const sun = new THREE.DirectionalLight(0xffffff, 1.15);
  sun.position.set(10, 18, 10);
  sun.castShadow = true;
  sun.shadow.mapSize.set(2048, 2048);
  sun.shadow.camera.near = 1;
  sun.shadow.camera.far = 110;
  sun.shadow.camera.left = -40;
  sun.shadow.camera.right = 40;
  sun.shadow.camera.top = 40;
  sun.shadow.camera.bottom = -40;
  scene.add(sun);
  scene.add(new THREE.AmbientLight(0xffffff, 0.45));

  // Ground
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(240, 240),
    new THREE.MeshStandardMaterial({ color: 0x6fbf73 })
  );
  ground.rotation.x = -Math.PI/2;
  ground.receiveShadow = true;
  ground.position.set(0, 0, -60);
  scene.add(ground);

  // Aisle landmark (optional)
  const aisle = new THREE.Mesh(
    new THREE.PlaneGeometry(5.0, 140),
    new THREE.MeshStandardMaterial({ color: 0xc9b08a })
  );
  aisle.rotation.x = -Math.PI/2;
  aisle.receiveShadow = true;
  aisle.position.set(0, 0.01, -65);
  scene.add(aisle);

  // Trees for ambience
  function addTree(x, z){
    const trunk = new THREE.Mesh(
      new THREE.CylinderGeometry(0.14,0.22,1.8,10),
      new THREE.MeshStandardMaterial({ color: 0x6d4c2f })
    );
    trunk.position.set(x, 0.9, z);
    trunk.castShadow = true;

    const crown = new THREE.Mesh(
      new THREE.SphereGeometry(1.0, 14, 10),
      new THREE.MeshStandardMaterial({ color: 0x2f7d32 })
    );
    crown.position.set(x, 2.2, z);
    crown.castShadow = true;

    scene.add(trunk, crown);
  }
  for (let i=0; i<26; i++){
    const x = (Math.random() * 120) - 60;
    const z = (Math.random() * 170) - 140;
    if (Math.abs(x) < 10 && z < 10 && z > -140) continue;
    addTree(x, z);
  }

  // -------------------------
  // 2) Controls + Movement
  // -------------------------
  const controls = new PointerLockControls(camera, document.body);
  scene.add(controls.getObject());

  let isPlaying = false;
  let isMobile = false;

  const velocity = new THREE.Vector3();
  const direction = new THREE.Vector3();
  const move = { forward:false, back:false, left:false, right:false };
  const clock = new THREE.Clock();

  // Free roam bounds
  const ROAM = { minX:-70, maxX:70, minZ:-170, maxZ:30 };
  const PLAYER_RADIUS = 0.45;

  function clampToRoamBounds(){
    const obj = controls.getObject();
    obj.position.x = THREE.MathUtils.clamp(obj.position.x, ROAM.minX, ROAM.maxX);
    obj.position.z = THREE.MathUtils.clamp(obj.position.z, ROAM.minZ, ROAM.maxZ);
    obj.position.y = 1.7;
  }

  // Keyboard movement
  function onKey(e, down){
    if (!isPlaying || isMobile) return;
    switch(e.code){
      case "KeyW":
      case "ArrowUp": move.forward = down; break;
      case "KeyS":
      case "ArrowDown": move.back = down; break;
      case "KeyA":
      case "ArrowLeft": move.left = down; break;
      case "KeyD":
      case "ArrowRight": move.right = down; break;
    }
  }
  addEventListener("keydown", e => onKey(e, true));
  addEventListener("keyup", e => onKey(e, false));

  // -------------------------
  // 3) Booths + Doors + Interiors
  // -------------------------
  const boothGroup = new THREE.Group();
  scene.add(boothGroup);

  const interactiveSigns = [];       // click to open info
  const boothGroups = [];            // for collision
  const colliders = [];              // AABB collision boxes

  // Door triggers (outside) and exit triggers (inside)
  const entryDoors = []; // { booth, pos:Vector3 }
  const exitDoors = [];  // { booth, pos:Vector3 }

  // Interior positions far away from outdoor area (so minimap doesn't show it)
  const INTERIOR_ORIGIN = new THREE.Vector3(420, 0, 420);
  const INTERIOR_SPACING = 40;

  // State: inside which booth?
  let insideBoothId = null;
  let lastOutdoorPos = new THREE.Vector3(0,1.7,6);

  function makeTextTexture(text){
    const cnv = document.createElement("canvas");
    cnv.width = 512; cnv.height = 256;
    const ctx = cnv.getContext("2d");
    ctx.fillStyle = "rgba(20,20,20,0.92)";
    ctx.fillRect(0,0,cnv.width,cnv.height);
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 44px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, cnv.width/2, cnv.height/2);
    const tex = new THREE.CanvasTexture(cnv);
    tex.anisotropy = 8;
    return tex;
  }

  function addBooth(b, idx){
    const x = (b.side === "left") ? -10 : 10;
    const z = b.z;

    const g = new THREE.Group();
    g.position.set(x, 0, z);

    // Tent legs
    const legMat = new THREE.MeshStandardMaterial({ color: 0x7a5a34 });
    const legGeo = new THREE.CylinderGeometry(0.05,0.05,1.5,10);
    for (const [lx,lz] of [[-0.9,-0.9],[0.9,-0.9],[-0.9,0.9],[0.9,0.9]]){
      const leg = new THREE.Mesh(legGeo, legMat);
      leg.position.set(lx, 0.75, lz);
      leg.castShadow = true;
      g.add(leg);
    }

    // Table
    const tableTop = new THREE.Mesh(
      new THREE.BoxGeometry(1.8, 0.1, 0.9),
      new THREE.MeshStandardMaterial({ color: 0x8b6a42 })
    );
    tableTop.position.set(0, 0.55, 0.15);
    tableTop.castShadow = true;
    tableTop.receiveShadow = true;
    g.add(tableTop);

    // Canopy
    const canopy = new THREE.Mesh(
      new THREE.ConeGeometry(1.55, 0.9, 4),
      new THREE.MeshStandardMaterial({ color: b.color })
    );
    canopy.position.set(0, 1.65, 0);
    canopy.castShadow = true;
    g.add(canopy);

    // Backdrop
    const back = new THREE.Mesh(
      new THREE.BoxGeometry(2.0, 1.55, 0.12),
      new THREE.MeshStandardMaterial({ color: 0xffffff })
    );
    back.position.set(0, 0.9, -0.95);
    back.castShadow = true;
    back.receiveShadow = true;
    g.add(back);

    // Sign board (click opens info modal)
    const sign = new THREE.Mesh(
      new THREE.BoxGeometry(1.9, 0.55, 0.07),
      new THREE.MeshStandardMaterial({ map: makeTextTexture(b.name) })
    );
    sign.position.set(0, 1.35, 1.15);
    sign.castShadow = true;
    sign.userData.booth = b;
    g.add(sign);
    interactiveSigns.push(sign);

    // Doorway marker (outside entry point)
    const door = new THREE.Mesh(
      new THREE.BoxGeometry(1.4, 2.1, 0.1),
      new THREE.MeshStandardMaterial({ color: 0x111111 })
    );
    door.position.set(0, 1.05, 0.65);
    door.castShadow = true;
    g.add(door);

    // Soft “welcome mat” to hint entry zone
    const mat = new THREE.Mesh(
      new THREE.PlaneGeometry(1.6, 0.9),
      new THREE.MeshStandardMaterial({ color: 0x2b2b2b })
    );
